pipeline {
     agent any

      tools{
	     jdk  'jdk17'
	     maven 'maven3'
	    }

  	    environment {
    	  Image_Name='jprakash1/todoapp-frontend'
    	  Container_Name = 'todofrontend-container'
    	  GITHUB_TOKEN = credentials('github_token')
    	  DOCKERHUB_TOKEN = credentials('docker-hub-cred')
	      SCANNER_HOME= tool 'sonarqube'
  	    }
  
    stages {         
        stage('Checkout Git') {
            steps {
       	       script {
                    checkout scmGit(branches: [[name: '*/dev-branch1']], extensions: [], userRemoteConfigs: [[credentialsId: 'github_token', url: 'https://github.com/techprakashtp/ThreeTierApp-Deployment.git']])
                        
          	     }
            	}
       	    }  	

        stage('SonarQube Analysis') {
            steps {
            	dir('ToDo-Frontend-App') {
			
                    withSonarQubeEnv('sonarqube') {

                         sh ''' 
       			         $SCANNER_HOME/bin/sonar-scanner \
 			         -Dsonar.projectKey=ThreeTierApp-Deployment \
 			         -Dsonar.projectName=ThreeTierApp-Deployment \
			         -Dsonar.javascript.lcov.reportPaths=./coverage/lcov.info

  		        	 '''
		            }
                }
            }
        }

        stage('Build Image') {         
            steps{  
                script {  
                    dir('ToDo-Frontend-App') {
                        docker.build "${Image_Name}"
                        echo 'Build Image Completed'   
		            }
                }
            }
        }
		
        stage('Push Image') {
            steps {
                script {
               	    withDockerRegistry(credentialsId: 'docker-hub-cred', toolName: 'Docker') {
                        docker.image("${Image_Name}").push()
                        echo 'Push Docker Image to Docker Hub Completed'
                    }
                }
            }
    	}

        stage('UpdateManifest') {
		        environment {
                  GIT_REPONAME = "ThreeTierApp-Deployment"
                  GIT_USERNAME = "techprakashtp"
           	    }
            steps {
       	        script {
                      checkout scmGit(branches: [[name: '*/ops-branch1']], extensions: [], userRemoteConfigs: [[credentialsId: 'github_token', url: 'https://github.com/techprakashtp/ThreeTierApp-Deployment.git']])

                    dir('K8S-Manifest/Frontend') {
                        withCredentials([gitUsernamePassword(credentialsId: 'github_token', gitToolName: 'Git')]) { 	

                                      sh '''
                    	  	 	 git config user.name "techprakashtp"
			   		 git config user.email "jyotiprakashnk49@gmail.com"  
			   		 
			   		 sed -i 's+${Image_Name}.*+${Image_Name}:$(DOCKERTAG)+g' deployment.yaml
			   		
			   		 git add deployment.yaml
			   		 git commit -m "changed manifest done by jenkins job \${BUILD_NUMBER}"
			   	         git push https://${github_token}@github.com/${GIT_USERNAME}/${GIT_REPONAME}HEAD:ops-branch1

        			        ''' 
                        }
                    }
                }
            }
        } 

        stage('Running Image') {
            steps {
              sh "docker run -d --name ${Container_Name} ${Repo_Name}:${BUILD_NUMBER}"
            }         
        }
        
        stage('Stop Container') {
            steps {
               sh "docker stop ${Container_Name}"
            }           
        }    	
    }
}
