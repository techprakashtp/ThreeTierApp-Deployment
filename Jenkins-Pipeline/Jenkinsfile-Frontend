pipeline {
     agent any

      tools{
	     jdk  'jdk17'
	     maven 'maven3'
	    }

  	    environment {
    	  Image_Name='jprakash1/todoapp-frontend'
    	  Container_Name = 'todofrontend-container'
    	  GITHUB_CRED = credentials('github-cred')
    	  DOCKERHUB_CRED_ = credentials('docker-hub-cred')
	      SCANNER_HOME= tool 'sonarqube'
  	    }
  
    stages {         
        stage('Checkout Git') {
            steps {
       	       script {
                    checkout scmGit(branches: [[name: '*/dev-branch1']], extensions: [], userRemoteConfigs: [[credentialsId: 'github-cred', url: 'https://github.com/techprakashtp/ThreeTierApp-Deployment.git']])
                        
          	     }
            	}
       	    }  	

        
        stage('Build Image') {         
            steps{  
                script {  
                    dir('ToDo-Frontend-App') {
                        docker.build "${Image_Name}"
                        echo 'Build Image Completed'   
		            }
                }
            }
        }
		
        stage('Push Image') {
            steps {
                script {
               	    withDockerRegistry(credentialsId: 'docker-hub-cred', toolName: 'Docker') {
                        docker.image("${Image_Name}").push()
                        echo 'Push Docker Image to Docker Hub Completed'
                    }
                }
            }
    	}

        stage('UpdateManifest') {
		        environment {
                  GIT_REPO_NAME = "ThreeTierApp-Deployment"
                  GIT_USER_NAME = "techprakashtp"
           	    }
            steps {
       	        script {
                      checkout scmGit(branches: [[name: '*/ops-branch1']], extensions: [], userRemoteConfigs: [[credentialsId: 'github-cred', url: 'https://github.com/techprakashtp/ThreeTierApp-Deployment.git']])

                    dir('K8S-Manifest/Frontend') {
                        withCredentials([gitUsernamePassword(credentialsId: 'github-cred', gitToolName: 'Git')]) { 	

                    sh '''
                    git config user.name "techprakashtp"
		    git config user.email "jyotiprakashnk49@gmail.com"  

		    BUILD_NUMBER=${BUILD_NUMBER}
                    echo $BUILD_NUMBER

                    imageTag=$(grep -oP '(?<=frontend:)[^ ]+' deployment.yaml)
                    echo $imageTag

                    sed -i "s/${Image_Name}:${imageTag}/${Image_Name}:${BUILD_NUMBER}/" deployment.yaml  

                    git add deployment.yaml

                    git commit -m "Update deployment Image to version \${BUILD_NUMBER}"
			
                    git push https://${GITHUB_CRED}@github.com/${GIT_USER_NAME}/${GIT_REPO_NAME} HEAD:ops-branch1

        	   ''' 
                        }
                    }
                }
            }
        } 

        stage('Running Image') {
            steps {
              sh "docker run -d --name ${Container_Name} ${Repo_Name}:${BUILD_NUMBER}"
            }         
        }
        
        stage('Stop Container') {
            steps {
               sh "docker stop ${Container_Name}"
            }           
        }    	
    }
}
