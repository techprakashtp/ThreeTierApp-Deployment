pipeline {
     agent any

      tools{
	     jdk  'jdk17'
	     maven 'maven3'
	    }

  	environment {
    	  IMAGE_NAME='jprakash1/todoapp-frontend'
          MAJOR_VERSION='1'
          MINOR_VERSION='0'
    	  CONTAINER_NAME = 'todofrontend-container'
    	  GITHUB_CRED = credentials('github-cred')
    	  DOCKERHUB_CRED_ = credentials('docker-hub-cred')
	      SCANNER_HOME= tool 'sonarqube'
  	    }
  
    stages {         
        stage('Checkout Git') {
            steps {
       	       script {
                    checkout scmGit(branches: [[name: '*/dev-branch1']], extensions: [], userRemoteConfigs: [[credentialsId: 'github-cred', url: 'https://github.com/techprakashtp/ThreeTierApp-Deployment.git']])
                        
          	     }
            	}
       	    }  	

        
        stage('Build Image') {         
            steps{  
                script {  
                    dir('ToDo-Frontend-App') {
                    def buildVersion = "${env.MAJOR_VERSION}.${env.MINOR_VERSION}"
                    docker.build "${IMAGE_NAME}:${buildVersion}"
                    echo 'Build Image Completed'   
		            }
                }
            }
        }
		
        stage('Push Image') {
            steps {
                script {
               	    withDockerRegistry(credentialsId: 'docker-hub-cred', toolName: 'Docker') {
                    def buildVersion = "${env.MAJOR_VERSION}.${env.MINOR_VERSION}"
                    docker.image("${IMAGE_NAME}:${buildVersion}").push()
                    echo 'Push Docker Image to Docker Hub Completed'
                    }
                }
            }
    	}

        stage('UpdateManifest') {
		  environment {
                  GIT_REPO_NAME = "ThreeTierApp-Deployment.git"
                  GIT_USER_NAME = "techprakashtp"
                  IMAGE_TAG="${env.MAJOR_VERSION}.${env.MINOR_VERSION}.${env.BUILD_NUMBER}"
           	    }
            steps {
       	        script {
                      checkout scmGit(branches: [[name: '*/ops-branch1']], extensions: [], userRemoteConfigs: [[credentialsId: 'github-cred', url: 'https://github.com/techprakashtp/ThreeTierApp-Deployment.git']])

                    dir('K8S-Manifest/Frontend') {
                        withCredentials([gitUsernamePassword(credentialsId: 'github-cred', gitToolName: 'Git')]) { 	

                sh '''
                    git config user.name "techprakashtp"
		    git config user.email "jyotiprakashnk49@gmail.com"  

                    sed -i 's/${IMAGE_NAME}:${PLACEHOLDER_TAG}/${IMAGE_NAME}:${IMAGE_TAG}/g' deployment.yaml 
		    cat deployment.yaml 
                    git add *.yaml

                    git commit -m "Update k8s deployment manifest file Image to version \${IMAGE_TAG}"
                    git push https://${GIT_USER_NAME}:${GITHUB_CRED}@github.com/${GIT_USER_NAME}/${GIT_REPO_NAME} HEAD:ops-branch1

        	     ''' 
                        }
                    }
                }
            }
        } 

        stage('Running Image') {
            steps {
              sh "docker run -d --name ${CONTAINER_NAME} ${IMAGE_NAME}:${BUILD_NUMBER}"
            }         
        }
        
        stage('Stop Container') {
            steps {
               sh "docker stop ${CONTAINER_NAME}"
            }           
        }    	
    }
}
